name: .NET Build, Test & Publish

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]      # Triggers publish on tags like v1.0.0
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x # Targets the latest .NET 10 (Jan 2026 standard)

    - name: Set Version
      id: vars
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Version from tag: $VERSION"
          echo "ver=$VERSION" >> $GITHUB_OUTPUT
        else
          echo "Not a tag. Using default CI version."
          echo "ver=0.0.0-ci" >> $GITHUB_OUTPUT
        fi

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release -p:Version=${{ steps.vars.outputs.ver }}

    - name: Test
      run: dotnet test ./tests/Surreal.Client.Rest.Test.Unit/Surreal.Client.Rest.Test.Unit.csproj --no-build --configuration Release --verbosity normal

    # --- PUBLISH STEP (Only runs on tags) ---
    - name: Pack
      if: startsWith(github.ref, 'refs/tags/v')
      run: dotnet pack ./src/Surreal.Client.Rest/Surreal.Client.Rest.csproj --no-build --configuration Release --output ./nupkgs -p:Version=${{ steps.vars.outputs.ver }}

    - name: Push to NuGet
      if: startsWith(github.ref, 'refs/tags/v')
      run: dotnet nuget push ./nupkgs/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json